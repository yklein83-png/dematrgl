# Session du 06 Janvier 2026

## Vue d'ensemble du projet

**Demat Regl** (Dématérialisation Réglementaire) est une plateforme de gestion de conformité pour les conseillers en gestion de patrimoine de Fare Epargne (Polynésie Française).

### Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                        FRONTEND                             │
│  React + TypeScript + MUI + Vite                            │
│  - Tunnel NEW : ClientForm (création client)                │
│  - Tunnel MODIF : DocumentEditor (modification client)      │
│  - Liste clients avec filtres et actions                    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        BACKEND                              │
│  FastAPI + SQLAlchemy (async) + PostgreSQL                  │
│  - API REST /api/v1/clients (CRUD 120+ champs)              │
│  - Authentification JWT                                     │
│  - Génération DOCX (QCC, RTO, etc.)                         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        DATABASE                             │
│  PostgreSQL 15                                              │
│  - Table clients (120+ colonnes)                            │
│  - Table users (conseillers, admins)                        │
│  - Table audit_log (traçabilité)                            │
└─────────────────────────────────────────────────────────────┘
```

### Workflow des statuts client

```
CRÉATION → brouillon → prospect → client_actif → client_inactif
              │            │            │               │
              │            │            │               └─ Manuel (archivage)
              │            │            └─ POST /validate
              │            └─ Docs partiellement signés
              └─ Aucun doc signé
```

**Logique métier :**
- `brouillon` : Aucun document signé - dossier en cours de constitution
- `prospect` : Documents partiellement signés (sauf RTO) - client potentiel engagé
- `client_actif` : Tous les documents signés - relation contractuelle établie
- `client_inactif` : Passage manuel - client parti/décédé/radié

> **Note** : La signature électronique n'étant pas encore implémentée, les transitions sont actuellement manuelles.

---

## Modifications de cette session

### 1. Fix des contraintes NOT NULL pour les brouillons

**Problème** : Impossible de sauvegarder un client en brouillon (données partielles) car les contraintes NOT NULL et CHECK rejetaient les valeurs NULL.

**Fichiers modifiés :**
- `backend/app/models/client.py` : Colonnes rendues nullable
- `database/schema.sql` : Contraintes mises à jour
- `backend/scripts/migration_allow_nulls_brouillon.sql` : Script de migration

**Colonnes affectées :**
- `t1_civilite`, `t1_nom`, `t1_prenom`, `t1_date_naissance`
- `situation_familiale`, `revenus_annuels_foyer`, `patrimoine_global`
- `objectifs_investissement`, `horizon_placement`, `tolerance_risque`
- `pertes_maximales_acceptables`, `origine_fonds_nature`

**Contraintes CHECK modifiées :**
- `chk_clients_statut` : Ajout de 'brouillon'
- `chk_clients_lcb_ft` : Ajout de 'Faible'
- `chk_clients_horizon`, `chk_clients_tolerance`, etc. : Acceptent NULL

---

### 2. Fix de la liste clients (ClientList.tsx)

**Problèmes corrigés :**

| Problème | Solution |
|----------|----------|
| Sélecteur statut avec mauvaises valeurs | Remplacé EN_COURS/VALIDE/ARCHIVE par brouillon/prospect/client_actif/client_inactif |
| Nom client non affiché | Changé `valueGetter` → `renderCell` (compatibilité MUI) |
| Suppression impossible pour conseillers | Changé `get_current_admin_user` → `get_current_active_user` avec vérification propriétaire |
| Téléphones mal formatés | Ajout fonction `formatPhoneNumber()` (+689 XX XX XX XX) |
| Statut affiché en texte brut | Utilisation du composant `<StatusChip>` |

**Fichiers modifiés :**
- `frontend/src/pages/clients/ClientList.tsx`
- `frontend/src/components/StatusChip.tsx` : Ajout statut 'brouillon'
- `backend/app/api/clients.py` : Fix permissions delete

---

### 3. Harmonisation des composants de saisie

**Problème** : Incohérences de format entre le tunnel NEW (ClientForm) et le tunnel MODIF (DocumentEditor).

**Solution** : Création de composants partagés dans `frontend/src/components/inputs/` :

| Composant | Description |
|-----------|-------------|
| `PhoneInput.tsx` | Format polynésien +689 XX XX XX XX |
| `CurrencyInput.tsx` | Symbole € avec séparateurs de milliers |
| `PercentInput.tsx` | Symbole % avec limite 0-100 |
| `FrenchDatePicker.tsx` | DatePicker localisé FR (dd/MM/yyyy) |

**Intégration :**
- `DocumentEditor.tsx` : Utilise les nouveaux composants
- Types de champs ajoutés : `'currency'`, `'percent'`

---

### 4. Autres corrections

- **Auth.py** : Fix async/await sur `AuditLog.log_action()`
- **Schemas client** : Gestion des champs manquants avec `getattr()`
- **StatusChip** : Couleur grise pour 'brouillon'

---

## Fichiers créés

```
frontend/src/components/inputs/
├── index.ts           # Exports
├── PhoneInput.tsx     # Saisie téléphone formaté
├── CurrencyInput.tsx  # Saisie monétaire
├── PercentInput.tsx   # Saisie pourcentage
└── FrenchDatePicker.tsx # DatePicker français

backend/scripts/
└── migration_allow_nulls_brouillon.sql  # Migration DB
```

---

## Prochaines étapes suggérées

1. **Signature électronique** : Implémenter pour automatiser les transitions de statut
2. **Boutons de transition manuelle** : Ajouter "Passer en prospect" / "Valider client" dans l'UI
3. **Harmoniser ClientForm** : Utiliser les mêmes composants inputs que DocumentEditor
4. **Tests E2E** : Valider le workflow complet brouillon → client_actif
